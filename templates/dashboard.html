<!-- Sistema SaaS CiviPro | Desenvolvido por Jo√£o Layon - Full Stack -->
{% extends "base.html" %}

{% block title %}Dashboard - CiviPro{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}

{% if projects_over_budget %}
<div class="mb-6 card bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800">
  <h3 class="text-lg font-bold mb-3 text-red-800 dark:text-red-200">‚ö†Ô∏è Alertas de Desperd√≠cio</h3>
  <div class="space-y-2">
    {% for proj in projects_over_budget[:3] %}
    <div class="p-3 rounded bg-white dark:bg-gray-800 border border-red-200 dark:border-red-700">
      <div class="flex justify-between items-center">
        <div>
          <span class="font-medium">{{ proj.name }}</span>
          <span class="text-sm text-red-600 dark:text-red-400 ml-2">
            +{{ "%.1f"|format(proj.diff_percent) }}% acima do planejado
          </span>
        </div>
        <div class="text-right">
          <div class="text-sm text-gray-500 dark:text-gray-400">Estimado: R$ {{ "%.2f"|format(proj.estimated) }}</div>
          <div class="text-sm font-bold text-red-600 dark:text-red-400">Real: R$ {{ "%.2f"|format(proj.real) }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üìÅ</div>
      <p class="text-2xl font-bold">{{ active_projects }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">Projetos Ativos</p>
      <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Total: {{ total_projects }}</p>
    </div>
  </div>
  
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üë§</div>
      <p class="text-2xl font-bold">{{ total_clients }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">Clientes</p>
    </div>
  </div>
  
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üè¢</div>
      <p class="text-2xl font-bold">{{ total_suppliers }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">Fornecedores</p>
    </div>
  </div>
  
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üß±</div>
      <p class="text-2xl font-bold">{{ total_materials }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">Materiais</p>
    </div>
  </div>
  
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üë∑</div>
      <p class="text-2xl font-bold">{{ total_labor }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">M√£o de Obra</p>
    </div>
  </div>
  
  <div class="card">
    <div class="text-center">
      <div class="text-3xl mb-2">üîß</div>
      <p class="text-2xl font-bold">{{ total_equipment }}</p>
      <p class="text-xs text-gray-500 dark:text-gray-400">Equipamentos</p>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
  <div class="card">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-500 dark:text-gray-400">Custo Estimado Total</p>
        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">R$ {{ "%.2f"|format(total_estimated) }}</p>
      </div>
      <div class="text-5xl">üí∞</div>
    </div>
  </div>
  
  <div class="card">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-500 dark:text-gray-400">Custo Real Total</p>
        <p class="text-3xl font-bold {% if total_real > total_estimated %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
          R$ {{ "%.2f"|format(total_real) }}
        </p>
        {% if total_estimated > 0 %}
        <p class="text-xs mt-1 {% if total_real > total_estimated %}text-red-500{% else %}text-green-500{% endif %}">
          {% if total_real > total_estimated %}
            +{{ "%.1f"|format((total_real - total_estimated) / total_estimated * 100) }}% acima
          {% else %}
            {{ "%.1f"|format((total_real - total_estimated) / total_estimated * 100) }}% do planejado
          {% endif %}
        </p>
        {% endif %}
      </div>
      <div class="text-5xl">üìä</div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <div class="card">
    <h3 class="text-lg font-semibold mb-4">Distribui√ß√£o de Custos por Tipo</h3>
    <canvas id="costDistributionChart" height="200"></canvas>
  </div>
  
  <div class="card">
    <h3 class="text-lg font-semibold mb-4">Comparativo: Estimado vs Real</h3>
    <canvas id="comparisonChart" height="200"></canvas>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="card">
    <h3 class="text-lg font-semibold mb-4">Projetos Recentes</h3>
    {% if projects %}
    <div class="space-y-2">
      {% for proj in projects[:5] %}
      <a href="{{ url_for('project_view', project_id=proj.id) }}" class="block p-3 rounded border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
        <div class="font-medium">{{ proj.name }}</div>
        <div class="text-sm text-gray-500 dark:text-gray-400">
          Cliente: {{ proj.client or '-' }} | √Årea: {{ proj.area }} m¬≤ | 
          <span class="{% if proj.status == 'em_andamento' %}text-blue-600{% elif proj.status == 'concluido' %}text-green-600{% else %}text-yellow-600{% endif %}">
            {{ {'em_andamento': 'Em Andamento', 'concluido': 'Conclu√≠do', 'pausado': 'Pausado'}.get(proj.status, 'Em Andamento') }}
          </span>
        </div>
      </a>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-gray-500 dark:text-gray-400">Nenhum projeto cadastrado</p>
    {% endif %}
    <a href="{{ url_for('projects_add') }}" class="mt-4 inline-block text-blue-600 dark:text-blue-400 hover:underline">+ Novo Projeto</a>
  </div>
  
  <div class="card">
    <h3 class="text-lg font-semibold mb-4">Custos por Projeto (Top 5)</h3>
    <canvas id="projectCostsChart" height="200"></canvas>
  </div>
</div>

<script>
const isDark = document.documentElement.classList.contains('dark');
const textColor = isDark ? '#fff' : '#000';
const gridColor = isDark ? '#374151' : '#e5e7eb';

const ctx1 = document.getElementById('costDistributionChart');
if (ctx1) {
  new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: ['Materiais', 'M√£o de Obra', 'Equipamentos'],
      datasets: [{
        data: [{{ cost_materials }}, {{ cost_labor }}, {{ cost_equipment }}],
        backgroundColor: [
          'rgba(59, 130, 246, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)'
        ],
        borderColor: [
          'rgb(59, 130, 246)',
          'rgb(16, 185, 129)',
          'rgb(245, 158, 11)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { 
          display: true,
          labels: { color: textColor }
        }
      }
    }
  });
}

const ctx2 = document.getElementById('comparisonChart');
if (ctx2) {
  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: [{% for proj in projects[:5] %}'{{ proj.name[:15] }}'{% if not loop.last %}, {% endif %}{% endfor %}],
      datasets: [
        {
          label: 'Estimado (R$)',
          data: [{% for cost in project_costs %}{{ cost }}{% if not loop.last %}, {% endif %}{% endfor %}],
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderColor: 'rgb(59, 130, 246)',
          borderWidth: 1
        },
        {
          label: 'Real (R$)',
          data: [{% for cost in project_real_costs %}{{ cost }}{% if not loop.last %}, {% endif %}{% endfor %}],
          backgroundColor: 'rgba(239, 68, 68, 0.6)',
          borderColor: 'rgb(239, 68, 68)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { 
          display: true,
          labels: { color: textColor }
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { color: textColor },
          grid: { color: gridColor }
        },
        x: {
          ticks: { color: textColor },
          grid: { color: gridColor }
        }
      }
    }
  });
}

const ctx3 = document.getElementById('projectCostsChart');
if (ctx3) {
  new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: [{% for proj in projects[:5] %}'{{ proj.name[:15] }}'{% if not loop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Custo Estimado (R$)',
        data: [{% for cost in project_costs %}{{ cost }}{% if not loop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(16, 185, 129, 0.6)',
        borderColor: 'rgb(16, 185, 129)',
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { 
          display: false
        }
      },
      scales: {
        x: { 
          beginAtZero: true,
          ticks: { color: textColor },
          grid: { color: gridColor }
        },
        y: {
          ticks: { color: textColor },
          grid: { color: gridColor }
        }
      }
    }
  });
}
</script>
{% endblock %}
